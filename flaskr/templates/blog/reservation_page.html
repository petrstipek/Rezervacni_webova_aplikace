{% extends "base.html" %}
{% from 'bootstrap5/form.html' import render_form %}

{% block head %}
    <title>Rezervační stránka</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

{% endblock %}

{% block body %}
<form method="post">
    {{ form.hidden_tag() }}
    <section class="section_blue" id="date_picker">
        <h3 class="global-margin">Výběr termínu rezervace</h3>
        <div class="container">
            <div id="datepicker"></div>
            <div class="times-container">
                <!-- The selected dates will be appended here -->
            </div>
        </div>
    </section>

    <section class="section_white" id="contact_information">
        <h3 class="global-margin">Kontaktní informace</h3>
        <label for="name">{{ form.name.label }}</label>
        {{ form.name }}
        <label for="surname">{{ form.surname.label }}</label>
        {{ form.surname }}
        <label for="tel_number">{{ form.tel_number.label }}</label>
        {{ form.tel_number }}
        <label for="email">{{ form.email.label }}</label>
        {{ form.email }}
    </section>

    <section class="section_blue" id="students">
        <h3 class="global-margin">Žáci</h3>

        <div class="form-row ">
            <input type="checkbox" id="same_as_student_client" name="same_as_client">
            <label for="same_as_student_client">Žák stejný jako klient</label>
            {{ form.age_client.label }} <br>
            {{ form.age_client(class_="age-field") }} <br>
            {% for error in form.age_client.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}

            {{ form.experience_client.label }} <br>
            {{ form.experience_client(class_="selector-field") }} <br>
            {% for error in form.experience_client.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}
        </div>
        <br>
        <div>
            <input type="checkbox" id="same_as_student_checkbox" name="same_as_student">
            <label for="same_as_student_checkbox">Objednat více žáků</label>
        </div>
        

        <!-- The section you want to toggle -->
        <div id="student_details_section" style="display: none;">
        <div class="form-row">
            <label for="name">{{ form.name_client1.label }}</label>
            {{ form.name_client1 }}
            
            <label for="surname">{{ form.surname_client1.label }}</label>
            {{ form.surname_client1 }}

            {{ form.age_client1.label }} <br>
            {{ form.age_client1(class_="age-field") }} <br>
            {% for error in form.age_client1.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}

            {{ form.experience_client1.label }} <br>
            {{ form.experience_client1(class_="selector-field") }} <br>
            {% for error in form.experience_client1.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}
        </div>
        <div class="form-row">
            <label for="name">{{ form.name_client2.label }}</label>
            {{ form.name_client2 }}

            <label for="surname">{{ form.surname_client2.label }}</label>
            {{ form.surname_client2 }}

            {{ form.age_client2.label }} <br>
            {{ form.age_client2(class_="age-field") }} <br>
            {% for error in form.age_client2.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}

            {{ form.experience_client2.label }} <br>
            {{ form.experience_client2(class_="selector-field") }} <br>
            {% for error in form.experience_client2.errors %}
                <span style="color: red;">{{ error }}</span>
            {% endfor %}
        </div>
</div>  
    </section>

    <section class="section_white" id="reservation_send">
        <h2 class="global-margin">Odeslání rezervace</h2>
        <div class="form-row">
            {{ form.note }}
            {{ form.submit }}
        </div>
    </section>
</form>
<script>
    $(document).ready(function(){
        $('#same_as_student_checkbox').change(function(){
            if(this.checked) {
                $('#student_details_section').show();
            } else {
                $('#student_details_section').hide();
            }
        });
    });
    </script>

<script>
    $(document).ready(function(){
        var availableTimes = JSON.parse('{{ available_times|safe }}');
        var selectedDate = ''; // Store the selected date in a broader scope
    
        $('#datepicker').datepicker({
            dateFormat: 'mm/dd/yy',
            onSelect: function(dateText) {
                selectedDate = dateText; // Update selectedDate when a date is picked
                var times = availableTimes[dateText] || [];
                var timesHtml = times.map(function(time) {
                    return `<label><input type="checkbox" name="time" value="${time}" /> ${time}</label><br>`;
                }).join('');
    
                $('.times-container').html(timesHtml);
            }
        });
    
        // Event delegation for dynamically added checkboxes
        $('.times-container').on('change', 'input[name="time"]', function() {
            if(this.checked) {
                // Prepare the data to be sent to the server
                var dataToSend = {
                    date: selectedDate,
                    time: $(this).val()
                };
                
                // Send the data to the server using AJAX
                $.ajax({
                    type: "POST",
                    url: "/submit-date-time",
                    contentType: "application/json",
                    data: JSON.stringify(dataToSend),
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader("X-CSRFToken", $("input[name='csrf_token']").val());
                    },
                    success: function(response) {
                        console.log("Data sent successfully", response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error sending data", error);
                    }
                });
            }
        });
    });
</script>


{% endblock %}

